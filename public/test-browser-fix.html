<!DOCTYPE html>
<html>
<head>
  <title>Test Supabase Browser Connection</title>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
</head>
<body>
  <h1>Testing Supabase Browser Connection</h1>
  <div id="output" style="white-space: pre-wrap; font-family: monospace; background: #f5f5f5; padding: 20px; margin: 20px 0;"></div>
  
  <script>
    const output = document.getElementById('output');
    function log(msg, isError = false) {
      const timestamp = new Date().toISOString().split('T')[1].split('.')[0];
      const line = `[${timestamp}] ${msg}`;
      console.log(line);
      output.textContent += line + '\n';
      if (isError) {
        output.style.borderLeft = '5px solid red';
      }
    }

    const supabaseUrl = 'https://oxtjonaiubulnggytezf.supabase.co';
    const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im94dGpvbmFpdWJ1bG5nZ3l0ZXpmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDgxOTM4ODgsImV4cCI6MjA2Mzc2OTg4OH0.9EsXc65D-5qgXLtu48d1E1Bll_AjaCt-a2-oPhZzUQU';

    async function testConnection() {
      try {
        // Test 1: Raw fetch
        log('=== TEST 1: Raw Fetch ===');
        const fetchStart = Date.now();
        const response = await fetch(`${supabaseUrl}/rest/v1/organizations?select=*`, {
          headers: {
            'apikey': supabaseAnonKey,
            'Authorization': `Bearer ${supabaseAnonKey}`,
            'Content-Type': 'application/json',
            'Accept': 'application/json'
          }
        });
        
        const fetchTime = Date.now() - fetchStart;
        log(`Fetch completed in ${fetchTime}ms`);
        log(`Status: ${response.status} ${response.statusText}`);
        
        const data = await response.json();
        log(`Data received: ${JSON.stringify(data, null, 2)}`);
        
      } catch (error) {
        log(`Fetch error: ${error.message}`, true);
        log(`Stack: ${error.stack}`, true);
      }

      try {
        // Test 2: Supabase Client
        log('\n=== TEST 2: Supabase Client ===');
        const { createClient } = supabase;
        const supabaseClient = createClient(supabaseUrl, supabaseAnonKey, {
          auth: {
            autoRefreshToken: false,
            persistSession: false
          },
          global: {
            headers: {
              'x-test-header': 'browser-test'
            }
          },
          db: {
            schema: 'public'
          },
          realtime: {
            params: {
              eventsPerSecond: 10
            }
          }
        });

        log('Client created, testing query...');
        const queryStart = Date.now();
        
        // Create a promise that will timeout
        const timeoutPromise = new Promise((_, reject) => {
          setTimeout(() => reject(new Error('Query timeout after 10 seconds')), 10000);
        });
        
        const queryPromise = supabaseClient
          .from('organizations')
          .select('*');
          
        const result = await Promise.race([queryPromise, timeoutPromise]);
        
        const queryTime = Date.now() - queryStart;
        log(`Query completed in ${queryTime}ms`);
        
        if (result.error) {
          log(`Query error: ${JSON.stringify(result.error, null, 2)}`, true);
        } else {
          log(`Query success! Data: ${JSON.stringify(result.data, null, 2)}`);
        }
        
      } catch (error) {
        log(`Supabase client error: ${error.message}`, true);
        log(`Stack: ${error.stack}`, true);
      }

      // Test 3: Check for service worker interference
      try {
        log('\n=== TEST 3: Service Worker Check ===');
        if ('serviceWorker' in navigator) {
          const registrations = await navigator.serviceWorker.getRegistrations();
          log(`Found ${registrations.length} service worker registrations`);
          for (const reg of registrations) {
            log(`SW Scope: ${reg.scope}, Active: ${reg.active ? 'Yes' : 'No'}`);
          }
        } else {
          log('Service workers not supported');
        }
      } catch (error) {
        log(`SW check error: ${error.message}`, true);
      }

      // Test 4: Network timing
      try {
        log('\n=== TEST 4: Network Performance ===');
        const perfEntries = performance.getEntriesByType('resource');
        const supabaseEntries = perfEntries.filter(e => e.name.includes('supabase'));
        
        if (supabaseEntries.length > 0) {
          log(`Found ${supabaseEntries.length} Supabase network requests:`);
          supabaseEntries.forEach(entry => {
            log(`  ${entry.name.split('/').pop()}: ${Math.round(entry.duration)}ms`);
          });
        } else {
          log('No Supabase network requests found in performance entries');
        }
      } catch (error) {
        log(`Performance check error: ${error.message}`, true);
      }

      log('\n=== ALL TESTS COMPLETE ===');
    }

    log('Starting connection tests...');
    testConnection();
  </script>
</body>
</html>